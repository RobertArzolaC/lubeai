{% extends "layouts/dashboard.html" %}
{% load static %}
{% load i18n %}

{% block title_page %}Dashboard{% endblock %}
{% block toolbar_title %}Dashboard{% endblock %}

{% block content %}
  {% if is_admin %}
    <main class="container-xxl">
      <!-- Filters Section -->
      <div class="row mb-6">
        <div class="col-12">
          <div class="card">
            <div class="card-header border-0 pt-6">
              <div class="card-title">
                <h3 class="fw-bolder">{% trans "Dashboard Filters" %}</h3>
              </div>
            </div>
            <div class="card-body">
              <form id="dashboardFilters" class="row g-3">
                <div class="col-md-2">
                  <label for="organization_id" class="form-label">{% trans "Organization" %}</label>
                  <select class="form-select" id="organization_id" name="organization_id">
                    <option value="">{% trans "All Organizations" %}</option>
                    {% for org in organizations %}
                    <option value="{{ org.id }}">{{ org.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="start_date" class="form-label">{% trans "Start Date" %}</label>
                  <input type="date" class="form-control" id="start_date" name="start_date">
                </div>
                <div class="col-md-2">
                  <label for="end_date" class="form-label">{% trans "End Date" %}</label>
                  <input type="date" class="form-control" id="end_date" name="end_date">
                </div>
                <div class="col-md-2">
                  <label for="machine_id" class="form-label">{% trans "Machine" %}</label>
                  <select class="form-select" id="machine_id" name="machine_id">
                    <option value="">{% trans "All Machines" %}</option>
                    {% for machine in machines %}
                    <option value="{{ machine.id }}">{{ machine.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="condition" class="form-label">{% trans "Condition" %}</label>
                  <select class="form-select" id="condition" name="condition">
                    <option value="">{% trans "All Conditions" %}</option>
                    {% for value, label in condition_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="status" class="form-label">{% trans "Status" %}</label>
                  <select class="form-select" id="status" name="status">
                    <option value="">{% trans "All Statuses" %}</option>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-12 d-flex align-items-end justify-content-end gap-4 mt-4">
                  <button type="button" class="btn btn-primary p-3" id="applyFilters">
                    <i class="fas fa-filter"></i> {% trans "Filter" %}
                  </button>
                  <button type="button" class="btn btn-secondary p-3" id="clearFilters">
                    <i class="fas fa-times"></i> {% trans "Clear" %}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Cards Row -->
      <div class="row g-5 g-xl-8 mb-6">
        <div class="col-xl-3">
          <div class="card card-xl-stretch mb-xl-8">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-50px me-5">
                  <span class="symbol-label bg-light-primary">
                    <i class="fas fa-file-alt fs-2x text-primary"></i>
                  </span>
                </div>
                <div class="text-end flex-grow-1">
                  <span class="text-muted fw-bolder d-block fs-7">{% trans "Total Reports" %}</span>
                  <span class="text-dark fw-bolder fs-3x" id="totalReportsKPI">{{ total_reports }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3">
          <div class="card card-xl-stretch mb-xl-8">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-50px me-5">
                  <span class="symbol-label bg-light-success">
                    <i class="fas fa-check-circle fs-2x text-success"></i>
                  </span>
                </div>
                <div class="text-end flex-grow-1">
                  <span class="text-muted fw-bolder d-block fs-7">{% trans "Normal Condition" %}</span>
                  <span class="text-dark fw-bolder fs-3x" id="normalConditionKPI">{{ condition_stats.NORMAL|default:0 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3">
          <div class="card card-xl-stretch mb-xl-8">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-50px me-5">
                  <span class="symbol-label bg-light-warning">
                    <i class="fas fa-exclamation-triangle fs-2x text-warning"></i>
                  </span>
                </div>
                <div class="text-end flex-grow-1">
                  <span class="text-muted fw-bolder d-block fs-7">{% trans "Caution" %}</span>
                  <span class="text-dark fw-bolder fs-3x" id="cautionConditionKPI">{{ condition_stats.CAUTION|default:0 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3">
          <div class="card card-xl-stretch mb-xl-8">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="symbol symbol-50px me-5">
                  <span class="symbol-label bg-light-danger">
                    <i class="fas fa-times-circle fs-2x text-danger"></i>
                  </span>
                </div>
                <div class="text-end flex-grow-1">
                  <span class="text-muted fw-bolder d-block fs-7">{% trans "Critical" %}</span>
                  <span class="text-dark fw-bolder fs-3x" id="criticalConditionKPI">{{ condition_stats.CRITICAL|default:0 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row g-5 g-xl-8 mb-6">
        <!-- Condition Distribution Donut Chart -->
        <div class="col-xl-6">
          <div class="card card-xl-stretch mb-xl-8">
            <div class="card-header border-0 pt-6">
              <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bolder fs-3 mb-1">{% trans "Condition Distribution" %}</span>
                <span class="text-muted fw-bold fs-7">{% trans "Reports by equipment condition" %}</span>
              </h3>
            </div>
            <div class="card-body">
              <div id="conditionChart" style="height: 350px;"></div>
            </div>
          </div>
        </div>

        <!-- Status Distribution Bar Chart -->
        <div class="col-xl-6">
          <div class="card card-xl-stretch mb-xl-8">
            <div class="card-header border-0 pt-6">
              <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bolder fs-3 mb-1">{% trans "Status Distribution" %}</span>
                <span class="text-muted fw-bold fs-7">{% trans "Reports by processing status" %}</span>
              </h3>
            </div>
            <div class="card-body">
              <div id="statusChart" style="height: 350px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Historical Trend Chart -->
      <div class="row g-5 g-xl-8 mb-6">
        <div class="col-xl-12">
          <div class="card card-xl-stretch mb-xl-8">
            <div class="card-header border-0 pt-6">
              <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bolder fs-3 mb-1">{% trans "Historical Trend" %}</span>
                <span class="text-muted fw-bold fs-7">{% trans "Reports over time" %}</span>
              </h3>
            </div>
            <div class="card-body">
              <div id="historicalChart" style="height: 400px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Latest Reports Table -->
      <div class="row g-5 g-xl-8 mb-6">
        <div class="col-12">
          <div class="card">
            <div class="card-header border-0 pt-6">
              <div class="card-title">
                <h3 class="fw-bolder">{% trans "Latest Reports" %}</h3>
              </div>
            </div>
            <div class="card-body pt-0">
              <div class="table-responsive">
                <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3" id="latestReportsTable">
                  <thead>
                    <tr class="fw-bolder text-muted">
                      <th class="min-w-120px">{% trans "Lab Number" %}</th>
                      <th class="min-w-140px">{% trans "Machine" %}</th>
                      <th class="min-w-120px">{% trans "Condition" %}</th>
                      <th class="min-w-120px">{% trans "Status" %}</th>
                      <th class="min-w-120px">{% trans "Sample Date" %}</th>
                    </tr>
                  </thead>
                  <tbody id="latestReportsBody">
                    {% for report in latest_reports %}
                      <tr>
                        <td class="fw-bolder">{{ report.lab_number }}</td>
                        <td>{{ report.machine.name|default:"N/A" }}</td>
                        <td>
                          <span class="badge badge-light-{% if report.condition == 'NORMAL' %}success{% elif report.condition == 'CAUTION' %}warning{% elif report.condition == 'CRITICAL' %}danger{% else %}dark{% endif %}">
                            {{ report.get_condition_display }}
                          </span>
                        </td>
                        <td>
                          <span class="badge badge-light-{% if report.status == 'PENDING' %}warning{% elif report.status == 'REVIEWED' %}info{% elif report.status == 'APPROVED' %}success{% else %}danger{% endif %}">
                            {{ report.get_status_display }}
                          </span>
                        </td>
                        <td>{{ report.sample_date|date:"Y-m-d"|default:"N/A" }}</td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="5" class="text-center text-muted">{% trans "No reports found" %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="text-end mb-4">
          <small class="text-muted">
              {% trans "Last updated" %}: {{ last_updated|date:"Y-m-d H:i" }}
          </small>
        </div>
      </div>
    </main>
  {% elif has_organization %}
    <!-- Coming Soon Dashboard for regular users -->
    <main class="container-xxl">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-20">
              <div class="symbol symbol-100px mx-auto mb-5">
                <span class="symbol-label bg-light-primary">
                  <i class="fas fa-chart-line fs-3x text-primary"></i>
                </span>
              </div>
              <h2 class="fw-bolder mb-5">{% trans "Dashboard Coming Soon" %}</h2>
              <p class="fs-6 text-muted mb-8">
                {% trans "We're working on an amazing dashboard experience for you. In the meantime, you can use our export features to analyze your data." %}
              </p>
              <div class="d-flex flex-center">
                <a href="{% url 'apps.dashboard:export' %}" class="btn btn-primary btn-lg me-3">
                  <i class="fas fa-file-export me-2"></i>
                  {% trans "Export Data" %}
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  {% else %}
    <!-- No access message -->
    <main class="container-xxl">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-20">
              <h2 class="fw-bolder">{% trans "Dashboard Access" %}</h2>
              <p class="fs-6 text-muted">{% trans "Contact your administrator to gain access to the dashboard." %}</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  {% endif %}
{% endblock content %}

{% block extra_js %}
  {% if is_admin %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Global variables for charts
          let conditionChart, statusChart, historicalChart;

          // Initial data from context
          const initialData = {
              condition_data: {{ condition_stats_parts|safe }},
              status_data: {{ status_stats|safe }},
              monthly_data: {{ monthly_data|safe }},
              total_reports: {{ total_reports }}
          };

          // Initialize charts with initial data
          initializeCharts(initialData);

          // Filter functionality
          document.getElementById('applyFilters').addEventListener('click', applyFilters);
          document.getElementById('clearFilters').addEventListener('click', clearFilters);

          // Dynamic machine filtering based on organization
          document.getElementById('organization_id').addEventListener('change', function() {
              const organizationId = this.value;
              updateMachineOptions(organizationId);
          });

          // Initial machines data for fallback
          const allMachinesData = [
              {% for machine in machines %}
              {id: {{ machine.id }}, name: "{{ machine.name|escapejs }}"},
              {% endfor %}
          ];

          function updateMachineOptions(organizationId) {
              const machineSelect = document.getElementById('machine_id');

              // Clear current options except "All Machines"
              machineSelect.innerHTML = '<option value="">{% trans "All Machines" %}</option>';

              if (organizationId) {
                  fetch(`{% url 'apps.dashboard:machines_api' %}?organization_id=${organizationId}`)
                      .then(response => response.json())
                      .then(data => {
                          data.machines.forEach(machine => {
                              const option = document.createElement('option');
                              option.value = machine.id;
                              option.textContent = machine.name;
                              machineSelect.appendChild(option);
                          });
                      })
                      .catch(error => console.error('Error loading machines:', error));
              } else {
                  // Load all machines when no organization is selected
                  allMachinesData.forEach(machine => {
                      const option = document.createElement('option');
                      option.value = machine.id;
                      option.textContent = machine.name;
                      machineSelect.appendChild(option);
                  });
              }
          }

          function initializeCharts(data) {
              // Condition Donut Chart
              const conditionOptions = {
                  series: Object.values(data.condition_data || {}),
                  chart: {
                      type: 'donut',
                      height: 350
                  },
                  labels: Object.keys(data.condition_data || {}),
                  colors: ['#50CD89', '#FFC700', '#F1416C'],
                  legend: {
                      position: 'bottom'
                  },
                  plotOptions: {
                      pie: {
                          donut: {
                              size: '65%'
                          }
                      }
                  },
                  dataLabels: {
                      enabled: true
                  },
                  responsive: [{
                      breakpoint: 480,
                      options: {
                          chart: {
                              width: 300
                          },
                          legend: {
                              position: 'bottom'
                          }
                      }
                  }]
              };

              conditionChart = new ApexCharts(document.querySelector("#conditionChart"), conditionOptions);
              conditionChart.render();

              // Status Bar Chart
              const statusOptions = {
                  series: [{
                      data: Object.values(data.status_data || {})
                  }],
                  chart: {
                      type: 'bar',
                      height: 350
                  },
                  xaxis: {
                      categories: Object.keys(data.status_data || {}),
                  },
                  colors: ['#3F4254'],
                  plotOptions: {
                      bar: {
                          horizontal: false,
                          columnWidth: '55%',
                          endingShape: 'rounded'
                      }
                  },
                  dataLabels: {
                      enabled: false
                  },
                  title: {
                      text: '',
                      align: 'left'
                  },
                  responsive: [{
                      breakpoint: 480,
                      options: {
                          chart: {
                              width: 300
                          }
                      }
                  }]
              };

              statusChart = new ApexCharts(document.querySelector("#statusChart"), statusOptions);
              statusChart.render();

              // Historical Line Chart
              const monthlyData = data.monthly_data || [];
              const historicalSeries = monthlyData.map(item => ({
                  x: new Date(item.month).getTime(),
                  y: item.count
              }));

              const historicalOptions = {
                  series: [{
                      name: 'Reports',
                      data: historicalSeries
                  }],
                  chart: {
                      type: 'area',
                      height: 400,
                      zoom: {
                          enabled: false
                      }
                  },
                  stroke: {
                      curve: 'smooth'
                  },
                  colors: ['#009EF7'],
                  xaxis: {
                      type: 'datetime',
                  },
                  yaxis: {
                      title: {
                          text: "{% trans 'Number of Reports' %}"
                      }
                  },
                  fill: {
                      type: 'gradient',
                      gradient: {
                          shadeIntensity: 1,
                          opacityFrom: 0.7,
                          opacityTo: 0.9,
                          stops: [0, 90, 100]
                      }
                  },
                  responsive: [{
                      breakpoint: 480,
                      options: {
                          chart: {
                              height: 300
                          }
                      }
                  }]
              };

              historicalChart = new ApexCharts(document.querySelector("#historicalChart"), historicalOptions);
              historicalChart.render();
          }

          function applyFilters() {
              const formData = new FormData(document.getElementById('dashboardFilters'));
              const params = new URLSearchParams();

              for (let [key, value] of formData.entries()) {
                  if (value) {
                      params.append(key, value);
                  }
              }

              showLoading(true);

              fetch(`{% url 'apps.dashboard:data_api' %}?${params.toString()}`)
                  .then(response => response.json())
                  .then(data => {
                      updateDashboard(data);
                      showLoading(false);
                  })
                  .catch(error => {
                      console.error('Error fetching data:', error);
                      showLoading(false);
                      alert('Error loading data. Please try again.');
                  });
          }

          function updateDashboard(data) {
              document.getElementById('totalReportsKPI').textContent = data.total_reports;

              const conditionCounts = {};
              data.condition_data.forEach(item => {
                  conditionCounts[item.condition] = item.count;
              });

              document.getElementById('normalConditionKPI').textContent = conditionCounts['NORMAL'] || 0;
              document.getElementById('cautionConditionKPI').textContent = conditionCounts['CAUTION'] || 0;
              document.getElementById('criticalConditionKPI').textContent = (conditionCounts['CRITICAL'] || 0);

              const conditionLabels = data.condition_data.map(item => item.condition);
              const conditionValues = data.condition_data.map(item => item.count);

              conditionChart.updateOptions({
                  labels: conditionLabels,
                  series: conditionValues
              });

              const statusLabels = data.status_data.map(item => item.status);
              const statusValues = data.status_data.map(item => item.count);

              statusChart.updateOptions({
                  xaxis: {
                      categories: statusLabels
                  },
                  series: [{
                      data: statusValues
                  }]
              });

              const historicalSeries = data.monthly_data.map(item => ({
                  x: new Date(item.month).getTime(),
                  y: item.count
              }));

              historicalChart.updateSeries([{
                  name: "{% trans 'Reports' %}",
                  data: historicalSeries
              }]);

              updateLatestReportsTable(data.latest_reports);
          }

          function updateLatestReportsTable(reports) {
              const tbody = document.getElementById('latestReportsBody');
              tbody.innerHTML = '';

              if (reports.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No reports found</td></tr>';
                  return;
              }

              reports.forEach(report => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                      <td class="fw-bolder">${report.lab_number}</td>
                      <td>${report.machine_name || 'N/A'}</td>
                      <td>
                          <span class="badge badge-light-${report.condition_class}">
                              ${report.condition}
                          </span>
                      </td>
                      <td>
                          <span class="badge badge-light-${report.status_class}">
                              ${report.status}
                          </span>
                      </td>
                      <td>${report.sample_date || 'N/A'}</td>
                  `;
                  tbody.appendChild(row);
              });
          }

          function clearFilters() {
              document.getElementById('dashboardFilters').reset();
              updateMachineOptions('');
              applyFilters();
          }

          function showLoading(show) {
              const elements = ['conditionChart', 'statusChart', 'historicalChart', 'latestReportsTable'];
              elements.forEach(id => {
                  const element = document.getElementById(id);
                  if (show) {
                      element.style.opacity = '0.5';
                      element.style.pointerEvents = 'none';
                  } else {
                      element.style.opacity = '1';
                      element.style.pointerEvents = 'auto';
                  }
              });
          }
      });
    </script>
  {% endif %}
{% endblock %}
