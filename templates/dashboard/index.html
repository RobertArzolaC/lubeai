{% extends "layouts/dashboard.html" %}
{% load static %}
{% load i18n %}

{% block title_page %}Dashboard{% endblock %}
{% block toolbar_title %}Dashboard{% endblock %}

{% block content %}
  {% if is_admin %}
    <!-- Admin Dashboard -->
    {% include 'dashboard/admin_dashboard.html' %}
  {% elif has_organization %}
    <!-- Organization Dashboard -->
    {% include 'dashboard/organization_dashboard.html' %}
  {% else %}
    <!-- No access message -->
    <main class="container-xxl">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-20">
              <h2 class="fw-bolder">{% trans "Dashboard Access" %}</h2>
              <p class="fs-6 text-muted">{% trans "Contact your administrator to gain access to the dashboard." %}</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  {% endif %}
{% endblock content %}

{% block extra_js %}
  {% if is_admin %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Global variables for charts
          let conditionChart, statusChart, historicalChart;

          // Initial data from context
          const initialData = {
              condition_data: {{ condition_stats_parts|safe }},
              status_data: {{ status_stats|safe }},
              monthly_data: {{ monthly_data|safe }},
              total_reports: {{ total_reports }}
          };

          // Initialize charts with initial data
          initializeCharts(initialData);

          // Filter functionality
          document.getElementById('applyFilters').addEventListener('click', applyFilters);
          document.getElementById('clearFilters').addEventListener('click', clearFilters);

          // Dynamic machine filtering based on organization
          document.getElementById('organization_id').addEventListener('change', function() {
              const organizationId = this.value;
              updateMachineOptions(organizationId);
          });

          // Initial machines data for fallback
          const allMachinesData = [
              {% for machine in machines %}
              {id: {{ machine.id }}, name: "{{ machine.name|escapejs }}"},
              {% endfor %}
          ];

          function updateMachineOptions(organizationId) {
              const machineSelect = document.getElementById('machine_id');

              // Clear current options except "All Machines"
              machineSelect.innerHTML = '<option value="">{% trans "All Machines" %}</option>';

              if (organizationId) {
                  fetch(`{% url 'apps.dashboard:machines_api' %}?organization_id=${organizationId}`)
                      .then(response => response.json())
                      .then(data => {
                          data.machines.forEach(machine => {
                              const option = document.createElement('option');
                              option.value = machine.id;
                              option.textContent = machine.name;
                              machineSelect.appendChild(option);
                          });
                      })
                      .catch(error => console.error('Error loading machines:', error));
              } else {
                  // Load all machines when no organization is selected
                  allMachinesData.forEach(machine => {
                      const option = document.createElement('option');
                      option.value = machine.id;
                      option.textContent = machine.name;
                      machineSelect.appendChild(option);
                  });
              }
          }

          function initializeCharts(data) {
              // Condition Donut Chart
              const conditionOptions = {
                  series: Object.values(data.condition_data || {}),
                  chart: {
                      type: 'donut',
                      height: 350
                  },
                  labels: Object.keys(data.condition_data || {}),
                  colors: ['#50CD89', '#FFC700', '#F1416C'],
                  legend: {
                      position: 'bottom'
                  },
                  plotOptions: {
                      pie: {
                          donut: {
                              size: '65%'
                          }
                      }
                  },
                  dataLabels: {
                      enabled: true
                  },
                  responsive: [{
                      breakpoint: 480,
                      options: {
                          chart: {
                              width: 300
                          },
                          legend: {
                              position: 'bottom'
                          }
                      }
                  }]
              };

              conditionChart = new ApexCharts(document.querySelector("#conditionChart"), conditionOptions);
              conditionChart.render();

              // Status Bar Chart
              const statusOptions = {
                  series: [{
                      data: Object.values(data.status_data || {})
                  }],
                  chart: {
                      type: 'bar',
                      height: 350
                  },
                  xaxis: {
                      categories: Object.keys(data.status_data || {}),
                  },
                  colors: ['#3F4254'],
                  plotOptions: {
                      bar: {
                          horizontal: false,
                          columnWidth: '55%',
                          endingShape: 'rounded'
                      }
                  },
                  dataLabels: {
                      enabled: false
                  },
                  title: {
                      text: '',
                      align: 'left'
                  },
                  responsive: [{
                      breakpoint: 480,
                      options: {
                          chart: {
                              width: 300
                          }
                      }
                  }]
              };

              statusChart = new ApexCharts(document.querySelector("#statusChart"), statusOptions);
              statusChart.render();

              // Historical Line Chart
              const monthlyData = data.monthly_data || [];
              const historicalSeries = monthlyData.map(item => ({
                  x: new Date(item.month).getTime(),
                  y: item.count
              }));

              const historicalOptions = {
                  series: [{
                      name: 'Reports',
                      data: historicalSeries
                  }],
                  chart: {
                      type: 'area',
                      height: 400,
                      zoom: {
                          enabled: false
                      }
                  },
                  stroke: {
                      curve: 'smooth'
                  },
                  colors: ['#009EF7'],
                  xaxis: {
                      type: 'datetime',
                  },
                  yaxis: {
                      title: {
                          text: "{% trans 'Number of Reports' %}"
                      }
                  },
                  fill: {
                      type: 'gradient',
                      gradient: {
                          shadeIntensity: 1,
                          opacityFrom: 0.7,
                          opacityTo: 0.9,
                          stops: [0, 90, 100]
                      }
                  },
                  responsive: [{
                      breakpoint: 480,
                      options: {
                          chart: {
                              height: 300
                          }
                      }
                  }]
              };

              historicalChart = new ApexCharts(document.querySelector("#historicalChart"), historicalOptions);
              historicalChart.render();
          }

          function applyFilters() {
              const formData = new FormData(document.getElementById('dashboardFilters'));
              const params = new URLSearchParams();

              for (let [key, value] of formData.entries()) {
                  if (value) {
                      params.append(key, value);
                  }
              }

              showLoading(true);

              fetch(`{% url 'apps.dashboard:data_api' %}?${params.toString()}`)
                  .then(response => response.json())
                  .then(data => {
                      updateDashboard(data);
                      showLoading(false);
                  })
                  .catch(error => {
                      console.error('Error fetching data:', error);
                      showLoading(false);
                      alert('Error loading data. Please try again.');
                  });
          }

          function updateDashboard(data) {
              document.getElementById('totalReportsKPI').textContent = data.total_reports;

              const conditionCounts = {};
              data.condition_data.forEach(item => {
                  conditionCounts[item.condition] = item.count;
              });

              document.getElementById('normalConditionKPI').textContent = conditionCounts['NORMAL'] || 0;
              document.getElementById('cautionConditionKPI').textContent = conditionCounts['CAUTION'] || 0;
              document.getElementById('criticalConditionKPI').textContent = (conditionCounts['CRITICAL'] || 0);

              const conditionLabels = data.condition_data.map(item => item.condition);
              const conditionValues = data.condition_data.map(item => item.count);

              conditionChart.updateOptions({
                  labels: conditionLabels,
                  series: conditionValues
              });

              const statusLabels = data.status_data.map(item => item.status);
              const statusValues = data.status_data.map(item => item.count);

              statusChart.updateOptions({
                  xaxis: {
                      categories: statusLabels
                  },
                  series: [{
                      data: statusValues
                  }]
              });

              const historicalSeries = data.monthly_data.map(item => ({
                  x: new Date(item.month).getTime(),
                  y: item.count
              }));

              historicalChart.updateSeries([{
                  name: "{% trans 'Reports' %}",
                  data: historicalSeries
              }]);

              updateLatestReportsTable(data.latest_reports);
          }

          function updateLatestReportsTable(reports) {
              const tbody = document.getElementById('latestReportsBody');
              tbody.innerHTML = '';

              if (reports.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No reports found</td></tr>';
                  return;
              }

              reports.forEach(report => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                      <td class="fw-bolder">${report.lab_number}</td>
                      <td>${report.machine_name || 'N/A'}</td>
                      <td>
                          <span class="badge badge-light-${report.condition_class}">
                              ${report.condition}
                          </span>
                      </td>
                      <td>
                          <span class="badge badge-light-${report.status_class}">
                              ${report.status}
                          </span>
                      </td>
                      <td>${report.sample_date || 'N/A'}</td>
                  `;
                  tbody.appendChild(row);
              });
          }

          function clearFilters() {
              document.getElementById('dashboardFilters').reset();
              updateMachineOptions('');
              applyFilters();
          }

          function showLoading(show) {
              const elements = ['conditionChart', 'statusChart', 'historicalChart', 'latestReportsTable'];
              elements.forEach(id => {
                  const element = document.getElementById(id);
                  if (show) {
                      element.style.opacity = '0.5';
                      element.style.pointerEvents = 'none';
                  } else {
                      element.style.opacity = '1';
                      element.style.pointerEvents = 'auto';
                  }
              });
          }
      });
    </script>
  {% endif %}
{% endblock %}
