{% load i18n static %}

<main class="container-xxl">
    <!-- Filters Section -->
    <div class="row mb-6">
    <div class="col-12">
        <div class="card">
        <div class="card-header border-0 pt-6">
            <div class="card-title">
            <h3 class="fw-bolder">{% trans "Dashboard Filters" %}</h3>
            </div>
        </div>
        <div class="card-body">
            <form id="dashboardFilters" class="row g-3">
            <div class="col-md-2">
                <label for="organization_id" class="form-label">{% trans "Organization" %}</label>
                <select class="form-select" id="organization_id" name="organization_id">
                <option value="">{% trans "All Organizations" %}</option>
                {% for org in organizations %}
                <option value="{{ org.id }}">{{ org.name }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="start_date" class="form-label">{% trans "Start Date" %}</label>
                <input type="date" class="form-control" id="start_date" name="start_date">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">{% trans "End Date" %}</label>
                <input type="date" class="form-control" id="end_date" name="end_date">
            </div>
            <div class="col-md-2">
                <label for="machine_id" class="form-label">{% trans "Machine" %}</label>
                <select class="form-select" id="machine_id" name="machine_id">
                <option value="">{% trans "All Machines" %}</option>
                {% for machine in machines %}
                <option value="{{ machine.id }}">{{ machine.name }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="condition" class="form-label">{% trans "Condition" %}</label>
                <select class="form-select" id="condition" name="condition">
                <option value="">{% trans "All Conditions" %}</option>
                {% for value, label in condition_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="status" class="form-label">{% trans "Status" %}</label>
                <select class="form-select" id="status" name="status">
                <option value="">{% trans "All Statuses" %}</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="col-md-12 d-flex align-items-end justify-content-end gap-4 mt-4">
                <button type="button" class="btn btn-primary p-3" id="applyFilters">
                <i class="fas fa-filter"></i> {% trans "Filter" %}
                </button>
                <button type="button" class="btn btn-secondary p-3" id="clearFilters">
                <i class="fas fa-times"></i> {% trans "Clear" %}
                </button>
            </div>
            </form>
        </div>
        </div>
    </div>
    </div>

    <!-- KPI Cards Row -->
    <div class="row g-5 g-xl-8 mb-6">
    <div class="col-xl-3">
        <div class="card card-xl-stretch mb-xl-8">
        <div class="card-body">
            <div class="d-flex align-items-center">
            <div class="symbol symbol-50px me-5">
                <span class="symbol-label bg-light-primary">
                <i class="fas fa-file-alt fs-2x text-primary"></i>
                </span>
            </div>
            <div class="text-end flex-grow-1">
                <span class="text-muted fw-bolder d-block fs-7">{% trans "Total Reports" %}</span>
                <span class="text-dark fw-bolder fs-3x" id="totalReportsKPI">{{ total_reports }}</span>
            </div>
            </div>
        </div>
        </div>
    </div>

    <div class="col-xl-3">
        <div class="card card-xl-stretch mb-xl-8">
        <div class="card-body">
            <div class="d-flex align-items-center">
            <div class="symbol symbol-50px me-5">
                <span class="symbol-label bg-light-success">
                <i class="fas fa-check-circle fs-2x text-success"></i>
                </span>
            </div>
            <div class="text-end flex-grow-1">
                <span class="text-muted fw-bolder d-block fs-7">{% trans "Normal Condition" %}</span>
                <span class="text-dark fw-bolder fs-3x" id="normalConditionKPI">{{ condition_stats.NORMAL|default:0 }}</span>
            </div>
            </div>
        </div>
        </div>
    </div>

    <div class="col-xl-3">
        <div class="card card-xl-stretch mb-xl-8">
        <div class="card-body">
            <div class="d-flex align-items-center">
            <div class="symbol symbol-50px me-5">
                <span class="symbol-label bg-light-warning">
                <i class="fas fa-exclamation-triangle fs-2x text-warning"></i>
                </span>
            </div>
            <div class="text-end flex-grow-1">
                <span class="text-muted fw-bolder d-block fs-7">{% trans "Caution" %}</span>
                <span class="text-dark fw-bolder fs-3x" id="cautionConditionKPI">{{ condition_stats.CAUTION|default:0 }}</span>
            </div>
            </div>
        </div>
        </div>
    </div>

    <div class="col-xl-3">
        <div class="card card-xl-stretch mb-xl-8">
        <div class="card-body">
            <div class="d-flex align-items-center">
            <div class="symbol symbol-50px me-5">
                <span class="symbol-label bg-light-danger">
                <i class="fas fa-times-circle fs-2x text-danger"></i>
                </span>
            </div>
            <div class="text-end flex-grow-1">
                <span class="text-muted fw-bolder d-block fs-7">{% trans "Critical" %}</span>
                <span class="text-dark fw-bolder fs-3x" id="criticalConditionKPI">{{ condition_stats.CRITICAL|default:0 }}</span>
            </div>
            </div>
        </div>
        </div>
    </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-5 g-xl-8 mb-6">
    <!-- Condition Distribution Donut Chart -->
    <div class="col-xl-6">
        <div class="card card-xl-stretch mb-xl-8">
        <div class="card-header border-0 pt-6">
            <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder fs-3 mb-1">{% trans "Condition Distribution" %}</span>
            <span class="text-muted fw-bold fs-7">{% trans "Reports by equipment condition" %}</span>
            </h3>
        </div>
        <div class="card-body">
            <div id="conditionChart" style="height: 350px;"></div>
        </div>
        </div>
    </div>

    <!-- Status Distribution Bar Chart -->
    <div class="col-xl-6">
        <div class="card card-xl-stretch mb-xl-8">
        <div class="card-header border-0 pt-6">
            <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder fs-3 mb-1">{% trans "Status Distribution" %}</span>
            <span class="text-muted fw-bold fs-7">{% trans "Reports by processing status" %}</span>
            </h3>
        </div>
        <div class="card-body">
            <div id="statusChart" style="height: 350px;"></div>
        </div>
        </div>
    </div>
    </div>

    <!-- Historical Trend Chart -->
    <div class="row g-5 g-xl-8 mb-6">
    <div class="col-xl-12">
        <div class="card card-xl-stretch mb-xl-8">
        <div class="card-header border-0 pt-6">
            <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder fs-3 mb-1">{% trans "Historical Trend" %}</span>
            <span class="text-muted fw-bold fs-7">{% trans "Reports over time" %}</span>
            </h3>
        </div>
        <div class="card-body">
            <div id="historicalChart" style="height: 400px;"></div>
        </div>
        </div>
    </div>
    </div>

    <!-- Latest Reports Table -->
    <div class="row g-5 g-xl-8 mb-6">
    <div class="col-12">
        <div class="card">
        <div class="card-header border-0 pt-6">
            <div class="card-title">
            <h3 class="fw-bolder">{% trans "Latest Reports" %}</h3>
            </div>
        </div>
        <div class="card-body pt-0">
            <div class="table-responsive">
            <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3" id="latestReportsTable">
                <thead>
                <tr class="fw-bolder text-muted">
                    <th class="min-w-120px">{% trans "Lab Number" %}</th>
                    <th class="min-w-140px">{% trans "Machine" %}</th>
                    <th class="min-w-120px">{% trans "Condition" %}</th>
                    <th class="min-w-120px">{% trans "Status" %}</th>
                    <th class="min-w-120px">{% trans "Sample Date" %}</th>
                </tr>
                </thead>
                <tbody id="latestReportsBody">
                {% for report in latest_reports %}
                    <tr>
                    <td class="fw-bolder">{{ report.lab_number }}</td>
                    <td>{{ report.machine.name|default:"N/A" }}</td>
                    <td>
                        <span class="badge badge-light-{% if report.condition == 'NORMAL' %}success{% elif report.condition == 'CAUTION' %}warning{% elif report.condition == 'CRITICAL' %}danger{% else %}dark{% endif %}">
                        {{ report.get_condition_display }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-light-{% if report.status == 'PENDING' %}warning{% elif report.status == 'REVIEWED' %}info{% elif report.status == 'APPROVED' %}success{% else %}danger{% endif %}">
                        {{ report.get_status_display }}
                        </span>
                    </td>
                    <td>{{ report.sample_date|date:"Y-m-d"|default:"N/A" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                    <td colspan="5" class="text-center text-muted">{% trans "No reports found" %}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        </div>
    </div>
    </div>

    <div class="row">
    <div class="text-end mb-4">
        <small class="text-muted">
            {% trans "Last updated" %}: {{ last_updated|date:"Y-m-d H:i" }}
        </small>
    </div>
    </div>
</main>
