{% extends "layouts/home.html" %}
{% load static %}
{% load i18n %}
{% load allauth %}

{% block title_page %}
    {% trans "Change Password" %}
{% endblock %}

{% block content %}
<div class="lubricant-login-container d-flex flex-column flex-lg-row flex-column-fluid">
    <!-- Brand Side Panel -->
    <div class="lubricant-login-brand d-flex flex-column flex-lg-row-auto w-xl-600px position-xl-relative">
        <div class="d-flex flex-column position-xl-fixed top-0 bottom-0 w-xl-600px scroll-y">
            <!-- Industrial Pattern Background -->
            <div class="d-flex flex-row-fluid flex-column text-center p-5 p-lg-10 pt-lg-20">
                <!-- Logo Section -->
                <div class="py-2 py-lg-10 mb-4">
                    <img
                        alt="{{ config.PROJECT_NAME }} Logo"
                        src="{% static 'assets/images/logos/logo.png' %}"
                        class="lubricant-logo max-h-75px"
                        height="50"
                    />
                </div>

                <!-- Brand Title -->
                <h1 class="lubricant-brand-title d-none d-lg-block fs-2qx pb-5 pb-md-8">
                    <i class="fas fa-lock lubricant-icon me-3 lubricant-pulse"></i>
                    {% trans "Welcome to" %} {{ config.PROJECT_NAME }}
                </h1>

                <!-- Brand Description -->
                <div class="d-none d-lg-block">
                    <p class="lubricant-brand-subtitle fs-2 mb-4">
                        <i class="fas fa-shield-alt lubricant-icon me-2"></i>
                        {% trans "Create a secure new password for your account" %}
                    </p>
                    <p class="lubricant-brand-subtitle fs-4 opacity-75">
                        {% trans "Strong encryption • Password protection • Secure authentication" %}
                    </p>
                </div>

                <!-- Mobile Brand -->
                <div class="d-lg-none text-center py-4">
                    <h2 class="lubricant-brand-title fs-1 mb-3">
                        {{ config.PROJECT_NAME }}
                    </h2>
                    <p class="lubricant-brand-subtitle fs-6">
                        {% trans "Change Password" %}
                    </p>
                </div>
            </div>

            <!-- Industrial Illustration -->
            <div class="d-none d-lg-block d-flex flex-row-auto justify-content-center align-items-end pb-10">
                <div class="text-center">
                    <i class="fas fa-user-lock lubricant-icon fa-5x opacity-50 mb-4"></i>
                    <div class="d-flex justify-content-center gap-3">
                        <i class="fas fa-key lubricant-icon fa-2x"></i>
                        <i class="fas fa-shield-alt text-warning fa-2x"></i>
                        <i class="fas fa-lock lubricant-icon fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Form Side -->
    <div class="d-flex flex-column flex-lg-row-fluid justify-content-center align-items-center py-10">
        <div class="w-100 w-lg-550px px-4 px-lg-0">
            {% if token_fail %}
                <!-- Token Invalid Card -->
                <div class="lubricant-login-form">
                    <div class="text-center mb-8">
                        <!-- Mobile Logo -->
                        <div class="d-lg-none mb-6">
                            <img alt="Logo" src="{% static 'assets/images/logos/logo.png' %}" class="lubricant-logo max-h-50px" height="35" />
                        </div>

                        <div class="mb-6">
                            <div class="symbol symbol-100px mb-5">
                                <div class="symbol-label bg-light-danger">
                                    <i class="fas fa-exclamation-triangle fs-2x text-danger"></i>
                                </div>
                            </div>
                        </div>

                        <h1 class="text-lubricant-primary mb-4 fs-2x fw-bold">
                            <i class="fas fa-link-slash lubricant-icon me-3"></i>
                            {% trans "Invalid Reset Link" %}
                        </h1>

                        <hr class="lubricant-divider">
                    </div>

                    <div class="alert alert-dismissible bg-light-danger border border-danger border-dashed d-flex flex-column p-5 mb-8">
                        <div class="d-flex flex-column text-center">
                            <h5 class="mb-3 text-gray-900">{% trans "Link Expired or Already Used" %}</h5>
                            {% url 'account_reset_password' as passwd_reset_url %}
                            <span class="text-gray-700 fs-6">
                                {% blocktrans %}The password reset link was invalid, possibly because it has already been used. Please request a new password reset.{% endblocktrans %}
                            </span>
                        </div>
                    </div>

                    <div class="d-grid mb-6">
                        <a href="{{ passwd_reset_url }}" class="btn btn-lg btn-primary py-4">
                            <i class="fas fa-redo me-3"></i>
                            {% trans "Request New Reset Link" %}
                        </a>
                    </div>

                    <div class="d-grid">
                        <a href="{% url "account_login" %}" class="btn btn-lg btn-light-primary py-4">
                            <i class="fas fa-arrow-left me-3"></i>
                            {% trans "Back to Login" %}
                        </a>
                    </div>
                </div>
            {% else %}
                <!-- Main Password Reset Form -->
                <div class="lubricant-login-form">
                    <!-- Form Header -->
                    <div class="text-center mb-10">
                        <!-- Mobile Logo -->
                        <div class="d-lg-none mb-6">
                            <img alt="Logo" src="{% static 'assets/images/logos/logo.png' %}" class="lubricant-logo max-h-50px" height="35" />
                        </div>

                        <h1 class="text-lubricant-primary mb-4 fs-2x fw-bold">
                            <i class="fas fa-key lubricant-icon me-3"></i>
                            {% trans "Setup New Password" %}
                        </h1>
                        <p class="text-lubricant-secondary fs-6 fw-semibold mb-4">
                            {% trans "Create a strong password to secure your account" %}
                        </p>
                        <div class="text-lubricant-medium fs-7 mb-6">
                            {% trans "Already reset your password?" %}
                            <a href="{% url "account_login" %}" class="lubricant-link fw-bold">
                                {% trans "Sign in here" %}
                            </a>
                        </div>
                        <hr class="lubricant-divider">
                    </div>

                    <!-- Password Reset Form -->
                    <form class="form w-100" method="POST" action="{{ action_url }}">
                        {% csrf_token %}
                        {{ redirect_field }}

                        <!-- Error Messages -->
                        {% if form.errors %}
                            <div class="alert alert-danger d-flex align-items-center p-5 mb-7">
                                <i class="fas fa-exclamation-circle fs-2hx text-danger me-4"></i>
                                <div class="d-flex flex-column">
                                    <h5 class="mb-1">{% trans "Please correct the following errors:" %}</h5>
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <span class="text-gray-700 fs-7">• {{ error }}</span>
                                        {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                        <span class="text-gray-700 fs-7">• {{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Password Field with Strength Meter -->
                        <div class="mb-8 fv-row" data-kt-password-meter="true">
                            <label class="lubricant-form-label required" for="password1">
                                {% trans "New Password" %}
                            </label>
                            <div class="position-relative mb-3">
                                <div class="input-group">
                                    <span class="input-group-text bg-lubricant-surface border-end-0">
                                        <i class="fas fa-lock text-lubricant-secondary"></i>
                                    </span>
                                    <input
                                        class="lubricant-form-control border-start-0 border-end-0 ps-5"
                                        type="password"
                                        placeholder="{% trans 'Enter new password' %}"
                                        name="password1"
                                        id="password1"
                                        autocomplete="new-password"
                                        required
                                    />
                                    <span class="input-group-text bg-lubricant-surface border-start-0 cursor-pointer" onclick="togglePassword('password1', 'togglePassword1Icon')">
                                        <i class="fas fa-eye text-lubricant-secondary" id="togglePassword1Icon"></i>
                                    </span>
                                </div>
                            </div>

                            <!-- Password Strength Meter -->
                            <div class="d-flex align-items-center mb-3" data-kt-password-meter-control="highlight">
                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px me-2"></div>
                                <div class="flex-grow-1 bg-secondary bg-active-success rounded h-5px"></div>
                            </div>
                            <div class="text-muted fs-7">
                                <i class="fas fa-info-circle me-1"></i>
                                {% trans "Use 8 or more characters with a mix of letters, numbers & symbols." %}
                            </div>
                        </div>

                        <!-- Confirm Password Field -->
                        <div class="fv-row mb-8">
                            <label class="lubricant-form-label required" for="password2">
                                {% trans "Confirm Password" %}
                            </label>
                            <div class="position-relative">
                                <div class="input-group">
                                    <span class="input-group-text bg-lubricant-surface border-end-0">
                                        <i class="fas fa-check-circle text-lubricant-secondary"></i>
                                    </span>
                                    <input
                                        class="lubricant-form-control border-start-0 border-end-0 ps-5"
                                        type="password"
                                        placeholder="{% trans 'Confirm new password' %}"
                                        id="password2"
                                        name="password2"
                                        autocomplete="new-password"
                                        required
                                    />
                                    <span class="input-group-text bg-lubricant-surface border-start-0 cursor-pointer" onclick="togglePassword('password2', 'togglePassword2Icon')">
                                        <i class="fas fa-eye text-lubricant-secondary" id="togglePassword2Icon"></i>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid mb-6">
                            <button type="submit" class="btn btn-lg btn-primary py-4">
                                <span class="indicator-label fs-5 fw-bold">
                                    <i class="fas fa-shield-alt me-3"></i>
                                    {% trans "Change Password" %}
                                </span>
                            </button>
                        </div>

                        <!-- Security Notice -->
                        <div class="text-center">
                            <small class="text-lubricant-medium d-flex align-items-center justify-content-center">
                                <i class="fas fa-lock me-2"></i>
                                {% trans "Your password will be encrypted and stored securely" %}
                            </small>
                        </div>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Password Toggle Script -->
<script>
function togglePassword(inputId, iconId) {
    const passwordInput = document.getElementById(inputId);
    const toggleIcon = document.getElementById(iconId);

    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    }
}

// Form submission loading state
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        const submitBtn = form.querySelector('button[type="submit"]');

        form.addEventListener('submit', function() {
            if (submitBtn) {
                submitBtn.classList.add('lubricant-loading');
                submitBtn.innerHTML = '<i class="fas fa-cog fa-spin me-2"></i>{% trans "Changing Password..." %}';
                submitBtn.disabled = true;
            }
        });
    }
});
</script>
{% endblock content %}
